// ═══════════════════════════════════════════════════════════════
//  Heimdell CRM — Outreach Orchestration Schema
//  Phase 1: Deterministic pipeline, audit logging, Sheets sync
// ═══════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────────

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
}

/// Deterministic lead statuses — no free-text. Order matters for Kanban.
enum LeadStatus {
  NEW
  CONTACTED_1
  WAITING_D2
  CALL_DUE
  CALLED
  WAITING_D1
  CONTACTED_2
  WA_VOICE_DUE
  REPLIED
  QUALIFIED
  NOT_INTERESTED
  COMPLETED
}

// ─── Identity ───────────────────────────────────────────────

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users         User[]
  leads         Lead[]
  auditLogs     AuditLog[]
  sheetsConfigs SheetsSyncConfig[]
  apiKeys       ApiKey[]

  @@map("organizations")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String    @map("password_hash")
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  role           UserRole  @default(OPERATOR)
  organizationId String    @map("organization_id")
  isActive       Boolean   @default(true) @map("is_active")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id])
  ownedLeads   Lead[]       @relation("LeadOwner")

  @@map("users")
}

// ─── Leads ──────────────────────────────────────────────────

model Lead {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // ── Core info
  company          String
  keyDecisionMaker String  @map("key_decision_maker")
  role             String?
  website          String?

  // ── Social (cleaned handles)
  facebookClean String? @map("facebook_clean")
  instaClean    String? @map("insta_clean")
  linkedinClean String? @map("linkedin_clean")

  // ── Contact
  emails      String[] @default([])
  number      String?
  mobileValid Boolean  @default(false) @map("mobile_valid")

  // ── Pipeline state (deterministic)
  status           LeadStatus @default(NEW)
  lastActionUtc    DateTime?  @map("last_action_utc")
  nextAction       String?    @map("next_action")
  nextActionDueUtc DateTime?  @map("next_action_due_utc")
  ownerId          String?    @map("owner_id")
  outcome          String?
  notes            String?
  qualified        Boolean    @default(false)

  // ── Action flags (each is set once, never unset)
  dmLiSent1   Boolean   @default(false) @map("dm_li_sent_1")
  dmFbSent1   Boolean   @default(false) @map("dm_fb_sent_1")
  dmIgSent1   Boolean   @default(false) @map("dm_ig_sent_1")
  emailSent1  Boolean   @default(false) @map("email_sent_1")
  callDone    Boolean   @default(false) @map("call_done")
  emailSent2  Boolean   @default(false) @map("email_sent_2")
  dmSent2     Boolean   @default(false) @map("dm_sent_2")
  waVoiceSent Boolean   @default(false) @map("wa_voice_sent")
  repliedAtUtc DateTime? @map("replied_at_utc")

  // ── Sheets sync tracking
  sheetsRowIndex Int?      @map("sheets_row_index")
  sheetsSyncedAt DateTime? @map("sheets_synced_at")

  // ── Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ── Relations
  organization Organization @relation(fields: [organizationId], references: [id])
  owner        User?        @relation("LeadOwner", fields: [ownerId], references: [id])
  auditLogs    AuditLog[]

  @@index([organizationId, status])
  @@index([organizationId, nextActionDueUtc])
  @@index([organizationId, ownerId])
  @@map("leads")
}

// ─── Audit (immutable append-only) ──────────────────────────

model AuditLog {
  id             String   @id @default(cuid())
  leadId         String   @map("lead_id")
  organizationId String   @map("organization_id")
  actor          String   // "user:<id>" | "system" | "agent:<key_name>"
  action         String   // "status_change" | "field_update" | "action_logged" | "sheets_sync_in"
  before         Json?    // snapshot of changed fields BEFORE
  after          Json?    // snapshot of changed fields AFTER
  timestampUtc   DateTime @default(now()) @map("timestamp_utc")
  source         String   // "api" | "agent" | "sync" | "scheduler"

  lead         Lead         @relation(fields: [leadId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([leadId])
  @@index([organizationId, timestampUtc])
  @@map("audit_logs")
}

// ─── Google Sheets Integration ──────────────────────────────

model SheetsSyncConfig {
  id                 String    @id @default(cuid())
  organizationId     String    @map("organization_id")
  sheetId            String    @map("sheet_id")
  tabName            String    @default("Sheet1") @map("tab_name")
  columnMapping      Json      @map("column_mapping")   // { "company": "A", "key_decision_maker": "B", ... }
  serviceAccountJson Json?     @map("service_account_json") // encrypted service account credentials
  lastSyncAt         DateTime? @map("last_sync_at")
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  organization Organization    @relation(fields: [organizationId], references: [id])
  syncLogs     SheetsSyncLog[]

  @@map("sheets_sync_configs")
}

model SheetsSyncLog {
  id            String    @id @default(cuid())
  configId      String    @map("config_id")
  direction     String    // "in" | "out"
  status        String    // "running" | "success" | "failed" | "partial"
  rowsProcessed Int       @default(0) @map("rows_processed")
  rowsCreated   Int       @default(0) @map("rows_created")
  rowsUpdated   Int       @default(0) @map("rows_updated")
  rowsSkipped   Int       @default(0) @map("rows_skipped")
  errors        Json?     @default("[]")
  dryRun        Boolean   @default(false) @map("dry_run")
  startedAt     DateTime  @default(now()) @map("started_at")
  completedAt   DateTime? @map("completed_at")

  config SheetsSyncConfig @relation(fields: [configId], references: [id])

  @@map("sheets_sync_logs")
}

// ─── API Keys (OpenClaw agent auth) ─────────────────────────

model ApiKey {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  name           String    // e.g. "openclaw-production"
  keyHash        String    @unique @map("key_hash")
  prefix         String    // first 8 chars for identification (e.g. "hmdl_abc1")
  permissions    String[]  @default(["read", "update", "transition", "note"])
  isActive       Boolean   @default(true) @map("is_active")
  lastUsedAt     DateTime? @map("last_used_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("api_keys")
}